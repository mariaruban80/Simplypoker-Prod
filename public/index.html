<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<link rel="preload" href="spade_1.png" as="image">
<link rel="icon" type="image/png" href="spade_1.png">     
<link rel="shortcut icon" href="spade_1.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">  
<link rel="stylesheet" href="Index_styles.css">
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="language-manager.js"></script>
<script src="jira-integration.js"></script>
<script type="module" src="/socket.io/socket.io.js"></script>
<script type="module" src="main.js"></script>      
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Planning Poker Interactive</title>
</head>
<body>

    <header>
  <div class="logo">
    <img src="spade_1.png" alt="Simply Poker" />
    <span class="logo-text">Simply Poker</span>

  </div>
  <div class="nav-links">    
   <button class="invite-button" id="inviteButton">Invite Others</button>    
    <!-- New user display element -->
  <div class="current-user-display" id="profileMenuTrigger" style="cursor:pointer;position:relative;">
    <div class="user-avatar" id="headerUserAvatar"></div>
    <span id="headerUsername">User</span>
    
  </div>
   </div>
      <!-- Profile Dropdown Menu -->
<div id="profileMenu" class="profile-menu">
  <div class="profile-menu-header">
    <img id="profileMenuAvatar" class="profile-avatar" src="" alt="avatar">
    <div>
      <div class="profile-menu-name" id="profileMenuName">User</div>
      <div class="profile-menu-email" id="profileMenuEmail" style="font-size:12px;color:#555;"></div>
    </div>
  </div>
<!-- Change Language -->
<button class="profile-menu-item" onclick="showLanguageModal()">
              <img src="https://flagcdn.com/gb.svg" alt="UK Flag" class="flag-icon" />&nbsp;Change Language
            </button>   
 <!-- Host Mode Toggle in Profile Menu -->
<div class="profile-menu-item" style="display:flex;justify-content:space-between;align-items:center;">
  <span>
    <i class="fas fa-user-shield" style="margin-right:8px;color:#673ab7;"></i>
    Host mode
  </span>
  <label class="switch">
    <input type="checkbox" id="hostModeToggle">
    <span class="slider round"></span>
  </label>
</div>

 <!-- Modal shown if someone else is already host -->
<div id="hostExistsModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
     background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 10000;">
  <div class="modal-content">
    <h3>Host Already Present</h3>
    <p>Another user is already the host in this session.</p>
    <div class="button-group">
      <button id="hostExistsOkBtn">Okay</button>
    </div>
  </div>
</div>  

<!-- Import from CSV -->
<button class="profile-menu-item" id="uploadTicketMenuBtn"> <svg xmlns="http://www.w3.org/2000/svg" 
viewBox="0 0 640 640" width="16" height="16" fill="currentColor" class="menu-icon">
<path d="M192 64C156.7 64 128 92.7 128 128L128 368L310.1 368L279.1 337C269.7 327.6 269.7 312.4 279.1 303.1C288.5 293.8 303.7 293.7 313 303.1L385 375.1C394.4 384.5 394.4 399.7 385 409L313 481C303.6 490.4 288.4 490.4 279.1 481C269.8 471.6 269.7 456.4 279.1 447.1L310.1 416.1L128 416.1L128 512.1C128 547.4 156.7 576.1 192 576.1L448 576.1C483.3 576.1 512 547.4 512 512.1L512 234.6C512 217.6 505.3 201.3 493.3 189.3L386.7 82.7C374.7 70.7 358.5 64 341.5 64L192 64zM453.5 240L360 240C346.7 240 336 229.3 336 216L336 122.5L453.5 240z"/> </svg> Import from CSV </button>

<!-- Import from JIRA -->

  <button class="profile-menu-item" id="jiraImportMenuBtn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             width="16" height="16" fill="currentColor" class="menu-icon">
          <path d="M11.53 2c0 2.4 1.97 4.37 4.37 4.37h.1v.1c0 2.4
                   1.97 4.37 4.37 4.37V2H11.53zM2 11.53c2.4 0
                   4.37 1.97 4.37 4.37v.1h.1c2.4 0 4.37 1.97
                   4.37 4.37H2V11.53z"/>
        </svg>
        Import from JIRA
      </button>     

   <!-- Export button here -->
  <button class="profile-menu-item" id="exportToCsvMenuBtn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" width="16" height="16" fill="currentColor" class="menu-icon">
      <path d="M128.5 64C93.2 64 64.5 92.7 64.5 128L64.5 512C64.5 547.3 93.2 576 128.5 576L384.5 576C419.8 576 448.5 547.3 448.5 512L448.5 416L526.6 416L495.6 447C486.2 456.4 486.2 471.6 495.6 480.9C505 490.2 520.2 490.3 529.5 480.9L601.5 408.9C610.9 399.5 610.9 384.3 601.5 375L529.5 303C520.1 293.6 504.9 293.6 495.6 303C486.3 312.4 486.2 327.6 495.6 336.9L526.6 367.9L448.5 367.9L448.5 234.4C448.5 217.4 441.8 201.1 429.8 189.1L323.2 82.7C311.2 70.7 295 64 278 64L128.5 64zM390 240L296.5 240C283.2 240 272.5 229.3 272.5 216L272.5 122.5L390 240zM256.5 392C256.5 378.7 267.2 368 280.5 368L384.5 368L384.5 416L280.5 416C267.2 416 256.5 405.3 256.5 392z"/>
    </svg>
    Export to CSV
  </button>    

<!-- Logout -->
  <button class="profile-menu-item logout" id="logoutMenuBtn">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"
       width="20" height="20" fill="currentColor" class="menu-icon">
    <path d="M224 160C241.7 160 256 145.7 256 128C256 110.3 241.7 96 224 96L160 96C107 96 64 139 64 192L64 448C64 501 107 544 160 544L224 544C241.7 544 256 529.7 256 512C256 494.3 241.7 480 224 480L160 480C142.3 480 128 465.7 128 448L128 192C128 174.3 142.3 160 160 160L224 160zM566.6 342.6C579.1 330.1 579.1 309.8 566.6 297.3L438.6 169.3C426.1 156.8 405.8 156.8 393.3 169.3C380.8 181.8 380.8 202.1 393.3 214.6L466.7 288L256 288C238.3 288 224 302.3 224 320C224 337.7 238.3 352 256 352L466.7 352L393.3 425.4C380.8 437.9 380.8 458.2 393.3 470.7C405.8 483.2 426.1 483.2 438.6 470.7L566.6 342.7z"/>
  </svg>
  Logout
</button>

     

 <!-- Language Selection Modal -->
<div id="languageModalCustom" style="display: none;">
  <div class="language-modal-content">
    <div class="language-modal-header">
      <h3>üåê Select Language</h3>
      <button class="close-button" onclick="hideLanguageModal()">&times;</button>
    </div>
    <div class="language-grid" id="languageGrid">
      <!-- Languages will be populated dynamically -->
    </div>
    <div class="language-modal-footer">
      <button id="applyLanguageBtn" class="language-apply-btn">Apply Changes</button>
      <button onclick="hideLanguageModal()" class="language-cancel-btn">Cancel</button>
    </div>
  </div>
</div>     
</header>
<!-- Create a completely new custom invite modal that doesn't use the same ID or classes as the original -->
<div id="inviteModalCustom">
<div class="modal-content">
<h3>Invite Link</h3>
<input id="inviteLinkCustom" readonly="" type="text"/>
<div class="button-group">
<button onclick="copyInviteLinkCustom()">Copy Link</button>
<button onclick="hideInviteModalCustom()">Close</button>
</div>
</div>
</div>
<!-- Custom Login Modal -->
<div id="loginModalCustom" style="display: none;">
  <div class="modal-content">
    <h3>Join Planning Poker Session</h3>
    <p>Please enter your name to join the session</p>
    <input id="userNameInput" type="text" placeholder="Your name" />
    <div class="button-group">
      <button id="joinSessionWithName" class="action-button">Join Session</button>
    </div>
  </div>
</div>    
<!-- Custom Add Ticket Modal -->
<div id="addTicketModalCustom" style="display: none;">
  <div class="modal-content add-ticket-modal">
    <h3>Add New Ticket</h3>
    <div class="input-group">
      <label for="ticketNameInput">ID</label>
      <input id="ticketNameInput" type="text" placeholder="Enter ticket ID">
    </div>
    <div class="input-group">
      <label for="ticketDescriptionEditor">Comment</label>
      <div id="ticketDescriptionEditor"></div>
    </div>
    <div class="button-group">
      <button id="cancelAddTicket" class="cancel-button">CANCEL</button>
      <button id="confirmAddTicket" class="confirm-button">
        <span class="plus-icon">+</span> ADD
      </button>
    </div>
  </div>
</div> 
<!-- Add this modal if it doesn't exist -->
<div id="hostModeErrorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px 32px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.2); max-width:350px; text-align:center;">
    <h2 style="margin-bottom:12px;color:#e53935;">Cannot become host</h2>
    <p style="margin-bottom:16px;">There is already another host in this session. Only one host is allowed per room.</p>
    <button onclick="document.getElementById('hostModeErrorModal').style.display='none';"
            style="padding:8px 16px; background:#753acb; color:white; border:none; border-radius:5px; cursor:pointer;">
      OK
    </button>
  </div>
</div>
<!-- CSV Upload Modal -->
<div id="csvUploadModal" style="display: none;">
  <div class="csv-modal-content">
    <!-- Step 1: File Upload -->
    <div id="csvUploadStep" class="csv-step active">
      <div class="csv-modal-header">
        <h3>Import from CSV file</h3>
        <button class="close-button" onclick="hideCsvUploadModal()">&times;</button>
      </div>
      
      <div class="csv-upload-section">
        <div class="csv-checkbox-container">
          <label class="csv-checkbox-label">
            <input type="checkbox" id="useFirstRowAsHeaders" checked>
            <span class="checkmark"></span>
            Use first csv row as headers
          </label>
        </div>
        
        <div class="csv-dropzone" id="csvDropzone">
          <div class="csv-drop-content">
            <div class="csv-drop-icon">üìÑ</div>
            <div class="csv-drop-text">
              <span>Drag 'n' drop some files here, or </span>
             
                 <button class="csv-choose-file-btn" type="button" onclick="triggerCsvFileInput()">choose file</button>
            </div>
          </div>
          <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        </div>
      </div>
    </div>
    
    <!-- Step 2: Field Mapping -->
    <div id="csvMappingStep" class="csv-step">
      <div class="csv-modal-header">
        <button class="csv-back-btn" onclick="goBackToCsvUpload()">‚Üê</button>
        <h3>Import from CSV file</h3>
        <button class="close-button" onclick="hideCsvUploadModal()">&times;</button>
      </div>
      
      <div class="csv-mapping-section">
        <div class="csv-mapping-dropdowns">
        <div class="csv-mapping-item">
            <label>Summary (required)</label>
            <select id="summaryMapping" class="csv-mapping-select" required>
              <option value="">Select...</option>
            </select>
          </div>
          
          <div class="csv-mapping-item">
            <label>Key</label>
            <select id="keyMapping" class="csv-mapping-select">
              <option value="">Select...</option>
            </select>
          </div>
          
          <div class="csv-mapping-item">
            <label>Description</label>
            <select id="descriptionMapping" class="csv-mapping-select">
              <option value="">Select...</option>
            </select>
          </div>
          
          <div class="csv-mapping-item">
            <label>Link</label>
            <select id="linkMapping" class="csv-mapping-select">
              <option value="">Select...</option>
            </select>
          </div>
          
          <div class="csv-mapping-item">
            <label>Estimate</label>
            <select id="estimateMapping" class="csv-mapping-select">
              <option value="">Select...</option>
            </select>
          </div>
        </div>

            <!-- ‚úÖ Add preview container here -->
    <div id="importPreview" 
         style="margin-top:15px; max-height:200px; overflow:auto; 
                border:1px solid #ccc; padding:8px; font-size:0.9em;">
    </div> 
           
        <div class="csv-modal-footer">
  <button class="csv-cancel-btn" onclick="hideCsvUploadModal()">Cancel</button>
  <button id="importCsvBtn" class="csv-import-btn">Import Issues</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Export CSV Modal -->
<div id="exportCsvModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Export Stories to CSV</h2>
    </div>
    <div class="modal-body">
      <div class="export-section">
        <h3>Field Mapping</h3>
        <p>Map your story fields to CSV columns:</p>
        <div class="field-mapping">
  <div class="mapping-row">
    <label>Story ID:</label>
    <select id="storyIdMapping" class="mapping-select">
      <option value="id" selected>Export Story ID</option>
      <option value="skip">Skip this field</option>
    </select>
  </div>
  
  <div class="mapping-row">
    <label>Title:</label>
    <select id="titleMapping" class="mapping-select">
      <option value="title" selected>Export Title</option>
      <option value="skip">Skip this field</option>
    </select>
  </div>
  
  <div class="mapping-row">
    <label>Description:</label>
    <select id="descriptionMapping" class="mapping-select">
      <option value="description" selected>Export Description</option>
      <option value="skip">Skip this field</option>
    </select>
  </div>
  
  <div class="mapping-row">
    <label>Story Points:</label>
    <select id="storyPointsMapping" class="mapping-select">
      <option value="storyPoints" selected>Export Story Points</option>
      <option value="skip">Skip this field</option>
    </select>
  </div>
  
  <div class="mapping-row">
    <label>Vote Count:</label>
    <select id="voteCountMapping" class="mapping-select">
      <option value="voteCount">Export Vote Count</option>
      <option value="skip" selected>Skip this field</option>
    </select>
  </div>
  
  <div class="mapping-row">
    <label>Average Vote:</label>
    <select id="averageVoteMapping" class="mapping-select">
      <option value="averageVote">Export Average Vote</option>
      <option value="skip" selected>Skip this field</option>
    </select>
  </div>
</div>

        
        <div class="export-options">
          <h3>Export Options</h3>
          <div class="export-options-inline">
            <label><input type="checkbox" id="includeHeader" checked> Include header row</label>
            <label><input type="checkbox" id="onlyRevealedStories"> Only export stories with revealed votes</label>
            <label><input type="checkbox" id="includeVoteDetails"> Include detailed vote information</label>
          </div>
        </div>
        
        <div class="preview-section">
          <h3>Preview</h3>
          <div id="exportPreviewTable" class="export-preview-table-container" style="max-height: 300px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
            <!-- Table preview will be generated here -->
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button id="generatePreviewBtn" class="btn btn-secondary">Update Preview</button>
      <button id="exportCsvBtn" class="btn btn-primary">Export CSV</button>
      <button id="cancelExportBtn" class="btn btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- JIRA Import Modal - Add this before </body> -->
<div id="jiraImportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10004; align-items: center; justify-content: center;">
  <div class="jira-modal-content">
    
    <!-- Step 1: Connection Setup -->
    <div id="jiraConnectionStep" class="jira-step active">
      <div class="jira-modal-header">
        <h3>üîó Connect to JIRA</h3>
        <button class="close-button" onclick="hideJiraImportModal()">&times;</button>
      </div>
      
      <div class="jira-connection-section">
        <div class="jira-form-group">
          <label for="jiraUrl">JIRA Instance URL:</label>
          <input type="url" id="jiraUrl" placeholder="https://yourcompany.atlassian.net" class="jira-input">
        </div>
        
        <div class="jira-form-group">
          <label for="jiraEmail">Email:</label>
          <input type="email" id="jiraEmail" placeholder="your-email@company.com" class="jira-input">
        </div>
        
        <div class="jira-form-group">
          <label for="jiraToken">API Token:</label>
          <input type="password" id="jiraToken" placeholder="Your JIRA API Token" class="jira-input">
          <small style="color: #666; display: block; margin-top: 5px;">
            <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank" style="color: #673ab7;">Generate API Token here</a>
          </small>
        </div>
        
        <div class="jira-form-group">
          <label for="jiraProject">Project Key:</label>
          <input type="text" id="jiraProject" placeholder="e.g., PROJ, DEV, TEST" class="jira-input">
        </div>

<!-- Add this instruction section -->
<div class="jira-instructions">
  <div class="instruction-item">
    <strong>üöÄ Smart Connect:</strong> Automatically tests your connection and discovers available projects. Use this if you're unsure about the project key.
  </div>
  <div class="instruction-item">
    <strong>üîó Connect & Load Stories:</strong> Directly connects using the details above and loads stories from the specified project.
  </div>
  <div class="instruction-note">
    <strong>üí° Tip:</strong> You can find your project key in JIRA by going to Project Settings ‚Üí Details, or it's usually shown in issue keys (e.g., "PROJ-123").
  </div>
</div>

<div id="jiraConnectionStatus" class="connection-status-indicator" style="display: none;">
  <span class="status-text"></span>
</div>
        
        <div id="jiraConnectionStatus" class="connection-status-indicator" style="display: none;">
          <span class="status-text"></span>
        </div>
      </div>
      
      <div class="jira-modal-footer">
        
        <button id="smartJiraConnect" class="jira-btn jira-btn-primary">üöÄ Smart Connect</button>   
        <button id="proceedToStories" class="jira-btn jira-btn-primary" disabled>Connect & Load Stories</button>
        <button onclick="hideJiraImportModal()" class="jira-btn jira-btn-cancel">Cancel</button>
      </div>
    </div>
    <!-- Step 2: Story Selection with header checkbox -->
<div id="jiraSelectionStep" class="jira-step">
  <div class="jira-modal-header">
    <button class="jira-back-btn" onclick="backToJiraConnection()">‚Üê</button>
    <h3>üìã Select Stories to Import</h3>
    <button class="close-button" onclick="hideJiraImportModal()">&times;</button>
  </div>
  
  <!-- Compact Filters Section -->
  <div class="jira-filters">
    <!-- Status and Issue Type in single row -->
    <div class="jira-filters-row">
      <div class="jira-filter-group">
        <label for="jiraStatusFilter">Status:</label>
        <select id="jiraStatusFilter" class="jira-select">
          <option value="">All Statuses</option>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
      
      <div class="jira-filter-group">
        <label for="jiraTypeFilter">Issue Type:</label>
        <select id="jiraTypeFilter" class="jira-select">
          <option value="">All Types</option>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
    </div>
    
    <!-- JQL Search in separate row -->
    <div class="jira-search-section">
      <label for="jiraJqlInput">JQL:</label>
      <input type="text" 
             id="jiraJqlInput" 
             class="jira-jql-input" 
             placeholder="ORDER BY Rank ASC"
             value="">
      <button id="jiraSearchBtn" class="jira-search-btn">SEARCH JIRA</button>
    </div>
  </div>
  
  <!-- Stories Container with Fixed Height and Scroll -->
  <div class="jira-stories-container">
    <div class="jira-stories-table-wrapper">
      <table class="jira-stories-table">
        <thead>
          <tr>
            <th class="select-column">
              <input type="checkbox" 
                     id="jiraSelectAllCheckbox" 
                     class="jira-header-checkbox"
                     title="Select/Deselect All">
            </th>
            <th class="key-column">Key</th>
            <th class="status-column">Status</th>
            <th class="name-column">Description</th>
          </tr>
        </thead>
        <tbody id="jiraStoriesTableBody">
          <!-- Stories will be populated here -->
        </tbody>
      </table>
    </div>
    
    <!-- Selection Count Bar - Always Visible -->
    <div class="jira-selection-count">
      <span id="selectedCount">0 selected</span>
    </div>
    
    <div id="jiraLoadingIndicator" style="display: none; text-align: center; padding: 40px; color: #666;">
      <div class="loading-spinner"></div>
      Loading JIRA stories...
    </div>
  </div>
  
  <!-- Footer Actions - Always Visible at Bottom -->
  <div class="jira-modal-footer">
    <button id="importSelectedStories" class="jira-btn jira-btn-primary" disabled>
      Import Selected Stories
    </button>
    <button onclick="hideJiraImportModal()" class="jira-btn jira-btn-cancel">
      Cancel
    </button>
  </div>
</div>
  </div>
</div>   

<div class="upload-section">
<div class="upload-right">
<div class="file-input" id="fileInputContainer">
<!--  <span class="file-button">Upload Ticket</span> -->
<input accept=".csv" id="csvInput" type="file"/>
</div>

</div>
</div>

<div class="container">
<div class="sidebar">
<h3>Current Members</h3>
<div id="userList"></div>
<!-- <h3 class="section-heading">Voting Controls</h3> -->
<!-- Added controls-section for better styling of control buttons -->
<div class="controls-section">
<button class="button" id="revealVotesBtn">Reveal Votes</button>
<button class="button" id="resetVotesBtn">Reset Votes</button>
<!-- <button class="button" id="exportCsvBtn">Export All Votes</button> -->
</div>
</div>
<div class="main">
<!-- Story will be displayed in the poker-table-layout instead of here -->
<!-- New poker table layout will be rendered here -->
<div class="user-circle-container" id="userCircle"></div>
<!-- Simple no stories message -->
<div class="no-stories-message" id="noStoriesMessage">
        No stories available. Please upload or add stories to start voting.
      </div> 
<!-- Planning cards -->
<div class="planning-cards-section">     
<h3>Planning Cards</h3>
     <div class="card-panel">
<div class="cards" id="planningCards">
<!--  <div class="card" data-value="0" draggable="true">0</div>
<div class="card" data-value="1" draggable="true">1</div>
<div class="card" data-value="3" draggable="true">3</div>
<div class="card" data-value="5" draggable="true">5</div>
<div class="card" data-value="8" draggable="true">8</div>
<div class="card" data-value="13" draggable="true">13</div>
<div class="card" data-value="21" draggable="true">21</div> -->    
</div>    
</div>
</div>
</div>
<div class="rightbar" id="storyListContainer">
<!-- Search box -->
<div class="search-container">
  <input type="text" id="ticketSearch" placeholder="Search and filter tickets...">
  <button id="filterBtn"><i class="fa fa-filter"></i></button>
</div>

<!-- Added ID to the ADD TICKET button -->
<button class="add-ticket-btn" id="addTicketBtn"><span>+</span>ADD TICKET</button>
<!-- The story list CONTAINER with no hardcoded stories -->
<div class="story-container" id="storyList">
<!-- Stories will be loaded dynamically -->
</div>
<!-- Navigation buttons -->
<div class="navigation-buttons">
<button class="button" id="prevStory">Previous Story</button>
<button class="button" id="nextStory">Next Story</button>
</div>
</div>
</div>
<!-- Scripts -->

<script>
     // Get values from sessionStorage

  const userName = sessionStorage.getItem("userName");
  const requestedHost = sessionStorage.getItem("requestedHost") === "true";

function updateHeaderStyle() {
  const style = document.createElement('style');
  style.textContent = `
    /* Reset header styles to match the image */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #f0f0f0;
      height: 60px;
      box-sizing: border-box;
    }
    
    /* Logo and text styling */
    .logo {
      display: flex;
      align-items: center;
    }
    
    .logo img {
      width: 32px;
      height: 32px;
      margin-right: 12px;
    }
    
    .logo span {
      font-size: 20px;
      font-weight: bold;
      color: #000;
      letter-spacing: 0.5px;
    }
    
    /* Nav links styling */
    .nav-links {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    /* Keep existing buttons but adjust general navigation style */
    .nav-links a, 
    .nav-links button:not(#logOffBtn):not(.current-user-display) {
      text-decoration: none;
      color: #555;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* Don't modify these elements */
    #headerUsername,
    #headerUserAvatar,
    #logOffBtn,
    .current-user-display {
      /* Preserve existing styles */
    }
  `;
  document.head.appendChild(style);
  
  // Optionally, update the logo element if needed
  const logoElement = document.querySelector('.logo img');
  if (logoElement) {
    // Update to a solid black spade if it's not already
    // Only do this if the logo needs updating
    // logoElement.src = 'blackspade.png'; 
  }
}
     
    // Function to check if there are any stories and update UI accordingly
    function checkForStories() {
      const storyList = document.getElementById('storyList');
      const noStoriesMessage = document.getElementById('noStoriesMessage');
      const planningCards = document.querySelectorAll('#planningCards .card');
      
      // Check if there are any story cards
      const storyCards = storyList ? storyList.querySelectorAll('.story-card') : [];
      const hasStories = storyCards.length > 0;
      
      if (!hasStories) {
        // No stories - disable planning cards
        planningCards.forEach(card => {
          card.classList.add('disabled');
          card.setAttribute('draggable', 'false');
        });
        
        // Show no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'block';
        }
      } else {
        // Has stories - enable planning cards
        planningCards.forEach(card => {
          card.classList.remove('disabled');
          card.setAttribute('draggable', 'true');
        });
        
        // Hide no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'none';
        }
      }
    }
// Initialize the user display in header - improved version

function initUserHeaderDisplay() {
  // Get username from session storage - prioritize the one set through login modal
  const username = sessionStorage.getItem('userName') || 'Guest';
  const usernameEl = document.getElementById('headerUsername');
  const avatarEl = document.getElementById('headerUserAvatar');
  
  if (usernameEl) usernameEl.textContent = username;
  
  if (avatarEl) {
    // Use the same avatar generation as the main app (generateAvatarUrl function already exists in main.js)
    const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=random&rounded=true`;
    
    avatarEl.innerHTML = `<img src="${avatarUrl}" alt="${username}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    
    // Fallback if image fails
    const imgElement = avatarEl.querySelector('img');
    if (imgElement) {
      imgElement.onerror = function() {
        const initials = username.split(' ')
          .map(part => part.charAt(0))
          .join('')
          .toUpperCase()
          .substring(0, 2);
          
        avatarEl.innerHTML = initials;
        
        const hue = Math.abs(username.split('').reduce((a, b) => {
          return a + b.charCodeAt(0);
        }, 0) % 360);
        
        avatarEl.style.backgroundColor = `hsl(${hue}, 70%, 60%)`;
        avatarEl.style.color = 'white';
        avatarEl.style.display = 'flex';
        avatarEl.style.alignItems = 'center';
        avatarEl.style.justifyContent = 'center';
        avatarEl.style.fontWeight = 'bold';
      };
    }
  }
}

// Handle username synchronization and prompt for invited users

document.addEventListener('DOMContentLoaded', function() {
  // STEP 1: Check for username from main.html (userName with capital N)
  const storedUserName = sessionStorage.getItem('userName');

  // STEP 2: Check if this is a new user joining via invite link
  const urlParams = new URLSearchParams(window.location.search);
  const isJoiningViaInvite = urlParams.has('roomId') && !storedUserName;

  if (isJoiningViaInvite) {
    // Someone joining via invite link who doesn't have a userName yet
    sessionStorage.setItem('isHost', 'false');
    sessionStorage.setItem('isRoomCreator', 'false');

    showLoginModal();

    // Prevent socket connect until user enters name
    window.userNameReady = false;
    hideMainContent();
  } else {
    window.userNameReady = true;

    if (!sessionStorage.getItem('isHost')) {
      const isCreator = sessionStorage.getItem('isRoomCreator') === 'true';
      sessionStorage.setItem('isHost', isCreator ? 'true' : 'false');
    }

    if (storedUserName) {
      setTimeout(initUserHeaderDisplay, 100);
    }
  }

  // Secure visibility of import buttons (temporary, overridden later by server response)
  const isHost = sessionStorage.getItem('isHost') === 'true';
  toggleHostFeatures(isHost);

  // Debugging
  console.log('Username from sessionStorage:', sessionStorage.getItem('userName'));
  console.log('Host status (pre-server):', sessionStorage.getItem('isHost'));
  console.log('Room creator:', sessionStorage.getItem('isRoomCreator'));

  // Keep header updated
  setInterval(function() {
    const usernameEl = document.getElementById('headerUsername');
    const currentStoredUserName = sessionStorage.getItem('userName');
    if (usernameEl && currentStoredUserName &&
       (usernameEl.textContent === 'User' || usernameEl.textContent === 'Guest')) {
      console.log('[HEADER] Fixing header with stored username:', currentStoredUserName);
      initUserHeaderDisplay();
    }
  }, 2000);

  // Attach login modal events
  const joinButton = document.getElementById('joinSessionWithName');
  if (joinButton) {
    joinButton.addEventListener('click', function() {
      setTimeout(() => {
        console.log('[LOGIN] Join button clicked, updating header');
        initUserHeaderDisplay();
      }, 100);
    });
  }

  const userNameInput = document.getElementById('userNameInput');
  if (userNameInput) {
    userNameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        setTimeout(() => {
          console.log('[LOGIN] Enter pressed, updating header');
          initUserHeaderDisplay();
        }, 100);
      }
    });
  }

  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      setTimeout(function() {
        const usernameEl = document.getElementById('headerUsername');
        const currentStoredUserName = sessionStorage.getItem('userName');
        if (usernameEl && currentStoredUserName && usernameEl.textContent === 'User') {
          initUserHeaderDisplay();
        }
      }, 500);
    }
  });

  // === SERVER-CONFIRMED JOIN LOGIC ===
  const socket = io();
  const sessionId = urlParams.get("roomId");
  const userName = sessionStorage.getItem("userName");
  const requestedHost = sessionStorage.getItem("requestedHost") === "true";

  if (sessionId && userName) {
    console.log("[CLIENT] Attempting to join session:", sessionId, "as", userName);
  //  sessionStorage.setItem("isHost", "false");
    socket.emit("joinSession", { sessionId, requestedHost, name: userName }, (response) => {
      console.log("[JOIN RESPONSE]", response);

      // Save confirmed host status
      sessionStorage.setItem("isHost", response.isHost ? "true" : "false");

      // Update UI
      toggleHostFeatures(response.isHost);
    });
  }

  // === LISTEN FOR HOST UPDATES ===
  socket.on("hostChanged", ({ hostId, userName }) => {
    if (socket.id === hostId) {
      sessionStorage.setItem("isHost", "true");
      toggleHostFeatures(true);
    } else {
      sessionStorage.setItem("isHost", "false");
      toggleHostFeatures(false);
    }
    console.log("[SOCKET] Host changed to:", userName);
  });

  socket.on("hostLeft", () => {
    console.log("[SOCKET] Host left the session");
    sessionStorage.setItem("isHost", "false");
    toggleHostFeatures(false);
  });

  // === HELPER FUNCTION ===
  function toggleHostFeatures(enable) {
    const uploadBtn = document.getElementById('uploadTicketMenuBtn');
    const exportBtn = document.getElementById('exportToCsvMenuBtn');
    const jiraImportBtn = document.getElementById('jiraImportMenuBtn');

    if (uploadBtn) uploadBtn.style.display = enable ? 'flex' : 'none';
    if (exportBtn) exportBtn.style.display = enable ? 'flex' : 'none';
    if (jiraImportBtn) {
      jiraImportBtn.style.display = enable ? 'flex' : 'none';
      if (enable) {
        jiraImportBtn.addEventListener('click', function() {
          window.JiraIntegration.showJiraImportModal();
        });
      }
    }
  }
});





// Setup mobile-specific features
function setupMobileLayout() {
  // Only run on mobile devices
  if (window.innerWidth <= 768) {
    console.log("Setting up mobile layout");
    
    // Create toggle buttons for mobile sections
    const userListSection = document.getElementById('userList');
    if (userListSection && userListSection.parentNode) {
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'mobile-toggle-button';
      toggleBtn.textContent = 'Current Members';
      toggleBtn.onclick = () => toggleMobileSection(userListSection);
      
      userListSection.parentNode.insertBefore(toggleBtn, userListSection);
      userListSection.classList.add('mobile-collapsible');
    }
    
    // Create toggle for story list container
    const storyListContainer = document.getElementById('storyList');
    if (storyListContainer && storyListContainer.parentNode) {
      const storyToggle = document.createElement('button');
      storyToggle.className = 'mobile-toggle-button';
      storyToggle.textContent = 'Story List';
      storyToggle.onclick = () => toggleMobileSection(storyListContainer);
      
      storyListContainer.parentNode.insertBefore(storyToggle, storyListContainer);
      storyListContainer.classList.add('mobile-collapsible');
    }
    
    // Enable touch for card selection
    setupMobileCardSelection();
  }
}

function toggleMobileSection(element) {
  element.classList.toggle('active');
  const button = element.previousElementSibling;
  if (button && button.classList.contains('mobile-toggle-button')) {
    button.classList.toggle('active');
  }
}

function setupMobileCardSelection() {
  document.querySelectorAll('#planningCards .card').forEach(card => {
    // Remove any existing handlers by cloning
    const newCard = card.cloneNode(true);
    if (card.parentNode) {
      card.parentNode.replaceChild(newCard, card);
    }
    
    // Add touch handler
    newCard.addEventListener('touchend', function(e) {
      e.preventDefault();
      
      // Get current user's vote space
      const userName = sessionStorage.getItem('userName');
      if (!userName) return;
      
      const safeId = userName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
      const voteSpace = document.getElementById(`vote-space-${safeId}`);
      
      if (voteSpace) {
        const vote = this.getAttribute('data-value');
        
        // Clear selections and add to this card
        document.querySelectorAll('#planningCards .card').forEach(c => {
          c.classList.remove('selected-card');
        });
        this.classList.add('selected-card');
        
        // Use the emitVote function if available
        if (typeof window.emitVote === 'function') {
          window.emitVote(vote, userName);
        } else if (typeof window.socket !== 'undefined') {
          window.socket.emit('castVote', { vote, targetUserId: userName });
        }
      }
    });
  });
}

// Listen for orientation changes to fix layout
window.addEventListener('orientationchange', function() {
  setTimeout(() => {
    if (typeof window.fixRevealedVoteFontSizes === 'function') {
      window.fixRevealedVoteFontSizes();
    }
  }, 300);
});

// Update existing handleLoginSubmit function to call our header update
const originalHandleLoginSubmit = window.handleLoginSubmit || function() {};
window.handleLoginSubmit = function() {
  const username = document.getElementById('userNameInput').value.trim();
  
  if (username) {
    // Store with both key formats for compatibility
    sessionStorage.setItem('userName', username);
    console.log(`User joined as: ${username}`);
    
    // Hide the modal
    document.getElementById('loginModalCustom').style.display = 'none';
    
    // Mark username as ready
    window.userNameReady = true;
    
    // Show main content
    if (window.showMainContent) window.showMainContent();
    
    // Initialize the app now that we have a username
    if (window.initializeAppWithName) window.initializeAppWithName(username);
    
    // Update header display with the new username
    setTimeout(initUserHeaderDisplay, 50);
  } else {
    // Show validation error - shake the input
    const input = document.getElementById('userNameInput');
    input.style.borderColor = '#ff4d4f';
    input.classList.add('shake');
    
    setTimeout(() => {
      input.classList.remove('shake');
    }, 500);
  }
};

// Also make sure to update the display whenever username changes
window.updateUserDisplay = function() {
  initUserHeaderDisplay();
};


// Also make sure to update the display whenever username changes
window.updateUserDisplay = function() {
  initUserHeaderDisplay();
};
// Add Ticket Modal Functions
function showAddTicketModal() {
  // Clear previous input values
  document.getElementById('ticketNameInput').value = '';
  if (window.quill) { quill.setContents([]); }
  
  // Show the modal
  document.getElementById('addTicketModalCustom').style.display = 'flex';
  
  // Focus on the name input
  setTimeout(() => {
    document.getElementById('ticketNameInput').focus();
  }, 100);
}

function handleAddTicketSubmit() {
  const ticketName = document.getElementById('ticketNameInput').value.trim();
  const ticketDescription = window.quill ? window.quill.root.innerHTML.trim() : '';

  // Validate input
  if (!ticketName) {
    const nameInput = document.getElementById('ticketNameInput');
    nameInput.classList.add('shake');
    nameInput.style.borderColor = '#ff4d4f';
    setTimeout(() => {
      nameInput.classList.remove('shake');
    }, 500);
    return;
  }

  // Prepare ticket text (combine name and description if provided)
  let ticketText = ticketName;
  if (ticketDescription) {
    ticketText = ticketName + ': ' + ticketDescription;
  }

  // Check if we're editing or adding
  const isEditing = !!window.editingTicketData;

  if (isEditing) {
    // Clean: Build update object ONCE, use all fields!
    const ticketData = {
      id: window.editingTicketData.id,
      text: ticketText,
      isEdit: true,
      idDisplay: ticketName,
      descriptionDisplay: ticketDescription
    };
    console.log('[EDIT] Updating ticket:', ticketData);

    if (window.updateTicketFromModal) {
      window.updateTicketFromModal(ticketData);
    } else {
      // Fallback: Update locally and emit to server
      updateTicketInUI(ticketData);
      if (window.socket) {
        window.socket.emit('updateTicket', ticketData);
      }
    }
    // Reset state and close modal
    hideAddTicketModal();
    resetAddTicketModal();
    window.editingTicketData = null;
  } else {
    // New ticket
    const ticketData = {
      id: `story_${Date.now()}`,
      text: ticketText,
      idDisplay: ticketName,
      descriptionDisplay: ticketDescription
    };
    hideAddTicketModal();
    if (window.addTicketFromModal) {
      window.addTicketFromModal(ticketData);
    } else {
      // Fallback
      const storyList = document.getElementById('storyList');
      if (storyList) {
        const storyCard = document.createElement('div');
        storyCard.className = 'story-card';
        storyCard.id = ticketData.id;
        const storyTitle = document.createElement('div');
        storyTitle.className = 'story-title';
        storyTitle.textContent = ticketData.text;
        storyCard.appendChild(storyTitle);
        storyList.appendChild(storyCard);
        if (window.socket) {
          window.socket.emit('addTicket', ticketData);
        }
      }
    }
  }
}
  


function hideAddTicketModal() {
  document.getElementById('addTicketModalCustom').style.display = 'none';
}

function resetAddTicketModal() {
  // Clear form inputs
  document.getElementById('ticketNameInput').value = '';
  if (window.quill) { quill.setContents([]); }
  
  // Reset modal title and button text
  const modalTitle = document.querySelector('#addTicketModalCustom h3');
  const confirmButton = document.getElementById('confirmAddTicket');
  
  if (modalTitle) modalTitle.textContent = 'Add New Ticket';
  if (confirmButton) {
    confirmButton.innerHTML = '<span class="plus-icon">+</span> ADD';
  }
  
  // Clear editing state
  window.editingTicketData = null;
}

     

// Set up event listeners for the add ticket modal
document.addEventListener('DOMContentLoaded', function() {
  // Set up Add Ticket button to use modal
  const addTicketBtn = document.getElementById('addTicketBtn');
  if (addTicketBtn) {
    // Remove any existing click handlers by cloning the button
    const newBtn = addTicketBtn.cloneNode(true);
    addTicketBtn.parentNode.replaceChild(newBtn, addTicketBtn);
    
    // Add new click handler for the modal
    newBtn.addEventListener('click', showAddTicketModal);
  }
  
  // Set up modal buttons
  document.getElementById('cancelAddTicket').addEventListener('click', function() {
  hideAddTicketModal();
  resetAddTicketModal();
});
  document.getElementById('confirmAddTicket').addEventListener('click', handleAddTicketSubmit);
  
  // Set up enter key in description field
  
});

// Expose function for main.js
window.showAddTicketModal = showAddTicketModal;
function isGuestUser() {
  // Primary check: sessionStorage
  const isHostFromStorage = sessionStorage.getItem('isHost');
  if (isHostFromStorage !== null) {
    return isHostFromStorage === 'false';
  }
  
  // Secondary check: URL has roomId but user didn't create room
  const urlParams = new URLSearchParams(window.location.search);
  const hasRoomId = urlParams.has('roomId');
  const isRoomCreator = sessionStorage.getItem('isRoomCreator') === 'true';
  
  return hasRoomId && !isRoomCreator;
}

    function setupGuestModeOnLoad() {
      if (isGuestUser()) {
        console.log('Guest mode activated - hiding control elements');
        
        // Hide control buttons in sidebar
        const revealVotesBtn = document.getElementById('revealVotesBtn');
        const resetVotesBtn = document.getElementById('resetVotesBtn');
        if (revealVotesBtn) revealVotesBtn.classList.add('hide-for-guests');
        if (resetVotesBtn) resetVotesBtn.classList.add('hide-for-guests');
                // Hide upload ticket button
        const fileInputContainer = document.getElementById('fileInputContainer');
        if (fileInputContainer) fileInputContainer.classList.add('hide-for-guests');
        
        // Hide add ticket button 
        const addTicketBtn = document.getElementById('addTicketBtn');
        if (addTicketBtn) addTicketBtn.classList.add('hide-for-guests');
        
 
      }
    }

    // Custom modal functions
    function showInviteModalCustom() {
      // First hide any existing modals from the original app
      hideAllOriginalModals();
          // Create a guest URL
      const currentUrl = new URL(window.location.href);
      const params = new URLSearchParams(currentUrl.search);
      const roomId = params.get('roomId');
      // Create clean guest URL (without host parameter)
      const guestUrl = `${currentUrl.origin}${currentUrl.pathname}?roomId=${roomId}`;
      // Set the link value
      //document.getElementById('inviteLinkCustom').value = window.location.href;
      document.getElementById('inviteLinkCustom').value = guestUrl;
      
    // Show our custom modal
  const modalElement = document.getElementById('inviteModalCustom');
  if (modalElement) {
    modalElement.style.display = 'flex';
  } else {
    console.error('Modal element not found!');
    // Fallback to alert if modal element is missing
    alert(`Share this invite link: ${guestUrl}`);
  }
}

    function hideInviteModalCustom() {
      document.getElementById('inviteModalCustom').style.display = 'none';
    }

    function copyInviteLinkCustom() {
      const inviteInput = document.getElementById('inviteLinkCustom');
      inviteInput.select();
      document.execCommand('copy');
      hideInviteModalCustom();
     // alert('Invite link copied!');
    }
    
    // Simple function to reveal votes - only toggles the body class
    function revealVotes() {
      document.body.classList.add('votes-revealed');
    }

    // Debugging function to help see what votes are stored
    function debugVotes() {
      console.clear();
      console.log("DEBUG: Checking all story cards for votes");
      
      const storyList = document.getElementById('storyList');
      const storyCards = Array.from(storyList?.querySelectorAll('.story-card') || []);
      
      console.log(`Found ${storyCards.length} story cards`);
      
      let totalVotes = 0;
      
      storyCards.forEach((card, index) => {
        console.group(`Story ${index + 1}: ${card.id}`);
        
        // Check data-vote attribute
        if (card.hasAttribute('data-vote')) {
          console.log(`‚úÖ data-vote attribute: "${card.getAttribute('data-vote')}"`);
          totalVotes++;
        } else {
          console.log("‚ùå No data-vote attribute");
        }
        
        // Check data-voted attribute
        if (card.hasAttribute('data-voted')) {
          console.log(`‚úÖ data-voted attribute: "${card.getAttribute('data-voted')}"`);
        } else {
          console.log("‚ùå No data-voted attribute");
        }
        
        // Check vote-badge elements
        const voteBadges = card.querySelectorAll('.vote-badge');
        if (voteBadges.length > 0) {
          console.log(`‚úÖ Found ${voteBadges.length} vote badge(s):`);
          voteBadges.forEach((badge, i) => {
            console.log(`   Badge ${i + 1}: "${badge.textContent}" (${badge.hidden ? 'hidden' : 'visible'})`);
          });
        } else {
          console.log("‚ùå No vote-badge elements");
        }
        
        console.groupEnd();
      });
      
      console.log(`Summary: Found ${totalVotes} stories with votes out of ${storyCards.length} total stories`);
      
      // Check if any planning cards are marked as selected
      const selectedCards = document.querySelectorAll('.card[data-selected="true"]');
      console.log(`Found ${selectedCards.length} selected planning cards`);
      selectedCards.forEach(card => {
        console.log(`   Value: ${card.getAttribute('data-value')}`);
      });
    }

    // IMPROVED: Export function that retrieves ONLY actual votes
    function exportAllVotes() {
      try {
        console.log("Export function started - retrieving actual votes only");
        
        // Force vote visibility for export
        document.body.classList.add('votes-revealed');
        
        // Get all story cards
        const storyList = document.getElementById('storyList');
        const storyCards = Array.from(storyList?.querySelectorAll('.story-card') || []);
        
        if (storyCards.length === 0) {
          alert('No stories available to export.');
          return;
        }
        
        console.log(`Found ${storyCards.length} story cards`);
        
        // Save current selection to restore later
        const originalSelectedStory = document.querySelector('.story-card.selected');
        
        // Prepare CSV content
        let csv = `Story ID,Story Description,Highest Vote\n`;
        
        // First, gather all existing votes
        console.log("Gathering all votes from story cards");
        
        // Process each story card
        storyCards.forEach((card, index) => {
          // Get story ID
          const storyId = card.id || `story_${index}`;
          
          // Get story description
          let storyDesc = '';
          const storyTitleElement = card.querySelector('.story-title');
          if (storyTitleElement) {
            storyDesc = storyTitleElement.textContent.trim();
          } else {
            storyDesc = card.textContent.trim();
          }
          
          // FOCUS: Find the actual vote for this story
          let highestVote = 'No votes';
          
          // Check data-vote attribute (primary storage method)
          if (card.hasAttribute('data-vote')) {
            const voteValue = card.getAttribute('data-vote');
            if (voteValue && !isNaN(voteValue)) {
              highestVote = voteValue;
              console.log(`Story ${storyId} has vote ${voteValue} from data-vote attribute`);
            }
          }
          
          // Check for vote-badge elements (secondary storage method)
          if (highestVote === 'No votes') {
            const voteBadges = card.querySelectorAll('.vote-badge');
            voteBadges.forEach(badge => {
              const voteText = badge.textContent.trim();
              if (voteText && !isNaN(voteText)) {
                highestVote = voteText;
                console.log(`Story ${storyId} has vote ${voteText} from vote-badge element`);
              }
            });
          }
          
          // Check data-voted attribute as indicator (tertiary check)
          if (highestVote === 'No votes' && card.hasAttribute('data-voted')) {
            // Story is marked as voted but no value found
            console.log(`Story ${storyId} is marked as voted but no value found`);
          }
          
          // Properly escape the description for CSV format
          const escapedDesc = storyDesc.includes('"') || storyDesc.includes(',') ? 
                             `"${storyDesc.replace(/"/g, '""')}"` : storyDesc;
          
          // Add this row to the CSV
          csv += `${storyId},${escapedDesc},${highestVote}\n`;
        });
        
        // Restore original selection
        if (originalSelectedStory) {
          document.querySelectorAll('.story-card').forEach(s => s.classList.remove('selected'));
          originalSelectedStory.classList.add('selected');
        }
        
        // Create and trigger the download
        console.log("Creating CSV file for download");
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'planning_poker_votes.csv');
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        
        // Clean up
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log("Export completed with actual votes only");
        
      } catch (error) {
        console.error('Error exporting votes:', error);
        alert('Error exporting votes: ' + (error.message || 'Unknown error'));
      }
    }

     document.addEventListener('DOMContentLoaded', function() {
  const oldCsvInput = document.getElementById('csvInput');
  if (oldCsvInput) {
    oldCsvInput.style.display = 'none';
    oldCsvInput.disabled = true;
    console.log('[CSV] Old CSV input disabled - using new modal system');
  }
});
    
    // Story selection functionality
    document.addEventListener('click', function(e) {
      const clickedStory = e.target.closest('.story-card');
      if (clickedStory) {
        // Deselect all stories
        document.querySelectorAll('.story-card').forEach(story => {
          story.classList.remove('selected');
        });
        
        // Select the clicked story
        clickedStory.classList.add('selected');
      }
    });
    
    // Previous and Next story button handlers
    document.getElementById('prevStory')?.addEventListener('click', function() {
      const selectedStory = document.querySelector('.story-card.selected');
      if (selectedStory && selectedStory.previousElementSibling) {
        selectedStory.classList.remove('selected');
        selectedStory.previousElementSibling.classList.add('selected');
      }
    });
    
    document.getElementById('nextStory')?.addEventListener('click', function() {
      const selectedStory = document.querySelector('.story-card.selected');
      if (selectedStory && selectedStory.nextElementSibling) {
        selectedStory.classList.remove('selected');
        selectedStory.nextElementSibling.classList.add('selected');
      }
    });
   

    // Add click handlers for planning cards - to store votes in data attributes
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        const selectedStory = document.querySelector('.story-card.selected');
        
        if (selectedStory) {
          // Store the vote directly on the story card as a data attribute
          selectedStory.setAttribute('data-vote', value);
          selectedStory.setAttribute('data-voted', 'true');
          
          // Store which card was selected
          document.querySelectorAll('.card').forEach(c => {
            c.removeAttribute('data-selected');
          });
          this.setAttribute('data-selected', 'true');
          
          // Update any vote badge if it exists
          let voteBadge = selectedStory.querySelector('.vote-badge');
          if (!voteBadge) {
            voteBadge = document.createElement('span');
            voteBadge.className = 'vote-badge';
            selectedStory.appendChild(voteBadge);
          }
          voteBadge.textContent = value;
        }
      });
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check for stories
      checkForStories();
      
      // Setup reveal button click handler
      const revealBtn = document.getElementById('revealVotesBtn');
      if (revealBtn) {
        revealBtn.addEventListener('click', revealVotes);
      }
      
      // Setup export button with direct onclick handler
      const exportBtn = document.getElementById('exportCsvBtn');
      if (exportBtn) {
        exportBtn.onclick = exportAllVotes;
      }
      
      // Setup invite button with direct handler to ensure it uses our custom modal
      const inviteBtn = document.getElementById('inviteButton');
      if (inviteBtn) {
        // Remove any existing handlers first by cloning and replacing
        const newInviteBtn = inviteBtn.cloneNode(true);
        inviteBtn.parentNode.replaceChild(newInviteBtn, inviteBtn);
        
        // Add our custom handler
        newInviteBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showInviteModalCustom();
        });
      }
      
      // Setup NEW SESSION button to include host parameter
      const newSessionBtn = document.getElementById('newSessionBtn');
      if (newSessionBtn) {
        newSessionBtn.addEventListener('click', function() {
          const roomId = 'room-' + Math.floor(Math.random() * 10000);
          window.location.href = `${window.location.origin}${window.location.pathname}?roomId=${roomId}&host=true`;
        });
      }
      
      // Setup guest mode restrictions
      setupGuestModeOnLoad();
      
      // Hide original modals
      hideAllOriginalModals();
    });
    
    // Watch for story list changes
    const storyList = document.getElementById('storyList');
    if (storyList) {
      const observer = new MutationObserver(function(mutations) {
        checkForStories();
      });
      
      observer.observe(storyList, { 
        childList: true,
        subtree: true
      });
    }
    
    // Override existing invite functions if they exist
    if (typeof openInviteModal === 'function') {
      console.log('Overriding existing openInviteModal function');
      window.openInviteModal = function() {
        showInviteModalCustom();
        return false;
      };
    }

window.editStory = function(ticketData) {
  let ticketName = ticketData.idDisplay !== undefined ? ticketData.idDisplay : '';
  let ticketDescription = ticketData.descriptionDisplay !== undefined ? ticketData.descriptionDisplay : '';

  // Fallback for legacy tickets
  if (!ticketName && ticketData.text) {
    if (ticketData.text.includes(': ')) {
      const parts = ticketData.text.split(': ', 2);
      ticketName = parts[0];
      ticketDescription = parts[1];
    } else {
      ticketName = ticketData.text;
    }
  }

  // Set the ticket name
  document.getElementById('ticketNameInput').value = ticketName;
  
  // **FIX: Handle HTML content properly in Quill editor**
  if (window.quill) {
    if (ticketDescription) {
      // If it's HTML, set it as HTML; if it's plain text, convert to HTML
      if (ticketDescription.includes('<') && ticketDescription.includes('>')) {
        // It's HTML content
        window.quill.root.innerHTML = ticketDescription;
      } else {
        // It's plain text, set as text
        window.quill.setText(ticketDescription);
      }
    } else {
      // Clear the editor
      window.quill.setText('');
    }
  }

  // Show modal and set editing state
  document.getElementById('addTicketModalCustom').style.display = 'flex';
  setTimeout(() => {
    document.getElementById('ticketNameInput').focus();
  }, 100);

  window.editingTicketData = ticketData;
  const modalTitle = document.querySelector('#addTicketModalCustom h3');
  const confirmButton = document.getElementById('confirmAddTicket');

  if (modalTitle) modalTitle.textContent = 'Edit Ticket';
  if (confirmButton) confirmButton.innerHTML = '<span class="plus-icon">‚úì</span> UPDATE';
};

     
  
  </script>

   <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if the button exists before trying to use it
            const logOffBtn = document.getElementById('logOffBtn');
            
            if (logOffBtn) {
                logOffBtn.addEventListener('click', function() {
                    // Clear session storage
                    sessionStorage.clear();
                    
                    // Redirect to main.html
                    window.location.href = 'About.html';
                });
            } else {
                console.error('Log Off button not found - make sure the button exists in HTML');
            }
        });
    </script>
   <!-- ENHANCED SCRIPT FOR USERNAME HANDLING -->
  <script src="/socket.io/socket.io.js"></script>  
<script type="module" src="socket.js"></script>
<script type="module" src="main.js"></script>

<script>
  // Global flag to track if username is ready
  window.userNameReady = false;
  // Handle username synchronization and prompt for invited users
document.addEventListener('DOMContentLoaded', function() {
  // STEP 1: Check for username from main.html (userName with capital N)
  const storedUserName = sessionStorage.getItem('userName');
  
  // STEP 2: Check if this is a new user joining via invite link
  const urlParams = new URLSearchParams(window.location.search);
  const isJoiningViaInvite = urlParams.has('roomId') && !storedUserName;
  
  if (isJoiningViaInvite) {
    // This is someone joining via invite link who doesn't have a userName yet
    // ‚úÖ Mark them as guest since they're joining via invite
    sessionStorage.setItem('isHost', 'false');
    sessionStorage.setItem('isRoomCreator', 'false');
    
    showLoginModal();
    
    // Important: Mark username as not ready to prevent socket connection
    window.userNameReady = false;
    
    // Hide main content until user provides name
    hideMainContent();
  } else {
    // User already has a name, mark as ready
    window.userNameReady = true;
    
    // ‚úÖ If no host status is set, check if they have room creator status
    if (!sessionStorage.getItem('isHost')) {
      const isCreator = sessionStorage.getItem('isRoomCreator') === 'true';
      sessionStorage.setItem('isHost', isCreator ? 'true' : 'false');
    }
    
    // ‚úÖ Update header if we have username
    if (storedUserName) {
      setTimeout(initUserHeaderDisplay, 100);
    }
  }
  
  // Debugging info
  console.log('Username from sessionStorage:', sessionStorage.getItem('userName'));
  console.log('Host status:', sessionStorage.getItem('isHost'));
  console.log('Room creator:', sessionStorage.getItem('isRoomCreator'));
});

  // Function to hide main content until user provides name
  function hideMainContent() {
    const container = document.querySelector('.container');
    const uploadSection = document.querySelector('.upload-section');
    
    if (container) container.style.display = 'none';
    if (uploadSection) uploadSection.style.display = 'none';
  }
  
  // Function to show main content after user provides name
  function showMainContent() {
    const container = document.querySelector('.container');
    const uploadSection = document.querySelector('.upload-section');
    
    if (container) container.style.display = 'flex';
    if (uploadSection) uploadSection.style.display = 'flex';
  }
  
  // Function to show custom login modal
  function showLoginModal() {
    const loginModal = document.getElementById('loginModalCustom');
    if (loginModal) {
      // Mark username as explicitly not ready to prevent socket connection
        window.userNameReady = false;  
        loginModal.style.display = 'flex';
      
      // Focus on the input field
      setTimeout(() => {
        document.getElementById('userNameInput').focus();
      }, 100);
      
      // Add event listener to join button
      document.getElementById('joinSessionWithName').addEventListener('click', handleLoginSubmit);
      
      // Add event listener for enter key
      document.getElementById('userNameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLoginSubmit();
        }
      });
    } else {
      // Fallback to prompt if modal doesn't exist
      fallbackToPrompt();
    }
  }
  
  // Function to handle login form submission
// Function to handle login form submission
function handleLoginSubmit() {
  const username = document.getElementById('userNameInput').value.trim();
  
  if (username) {
    // Store with both key formats for compatibility
    sessionStorage.setItem('userName', username);
    
    // ‚úÖ Ensure guest status is maintained for invited users
    if (!sessionStorage.getItem('isHost')) {
      sessionStorage.setItem('isHost', 'false');
      sessionStorage.setItem('isRoomCreator', 'false');
    }
    
    console.log(`User joined as: ${username}`);
    
    // Hide the modal
    document.getElementById('loginModalCustom').style.display = 'none';
    
    // Mark username as ready
    window.userNameReady = true;
    
    // Show main content
    showMainContent();
    
    // Initialize the app now that we have a username
    initializeAppWithName(username);
  } else {
    // Show validation error - shake the input
    const input = document.getElementById('userNameInput');
    input.style.borderColor = '#ff4d4f';
    input.classList.add('shake');
    
    setTimeout(() => {
      input.classList.remove('shake');
    }, 500);
  }
}

  // Initialize the app with the provided username
  function initializeAppWithName(username) {
    // Initialize socket connection with the username
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');
    
    if (window.initializeSocketWithName) {
      window.initializeSocketWithName(roomId, username);
    } else {
      // Fallback to reloading if the function isn't available
      window.location.reload();
    }
  }
  
  // Fallback to browser prompt if modal doesn't exist
  function fallbackToPrompt() {
    const username = prompt('Please enter your name to join the planning poker session:');
    
    if (username && username.trim()) {
      // Store with both key formats for compatibility
      sessionStorage.setItem('userName', username.trim());
      console.log(`User joined as: ${username.trim()}`);
      
      // Mark username as ready
      window.userNameReady = true;
      
      // Show main content and initialize
      showMainContent();
      initializeAppWithName(username.trim());
    } else {
      // If no username provided, set a default
      const guestName = 'Guest ' + Math.floor(Math.random() * 1000);
      sessionStorage.setItem('userName', guestName);
      alert(`You will join as "${guestName}"`);
      
      // Mark username as ready
      window.userNameReady = true;
      
      // Show main content and initialize
      showMainContent();
      initializeAppWithName(guestName);
    }
  }
  
  // Make getUserName function available globally for socket.js
  window.getUserName = function() {
    return sessionStorage.getItem('userName') || 'Anonymous';
  };
  
  // Add a little shake animation for validation errors
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
  `;
  document.head.appendChild(style);
</script> 
    
    <script>
  // Expose modal functions to window scope for main.js to use
  window.showInviteModalCustom = function() {
    // First hide any existing modals from the original app
    if (typeof hideAllOriginalModals === 'function') {
      hideAllOriginalModals();
    }
    
    // Create a guest URL
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    const roomId = params.get('roomId');
    
    // Create clean guest URL (without host parameter)
    const guestUrl = `${currentUrl.origin}${currentUrl.pathname}?roomId=${roomId}`;
    
    // Set the link value
    document.getElementById('inviteLinkCustom').value = guestUrl;
    
    // Show our custom modal
    document.getElementById('inviteModalCustom').style.display = 'flex';
  };
  
  window.hideInviteModalCustom = function() {
    document.getElementById('inviteModalCustom').style.display = 'none';
  };
  
  window.copyInviteLinkCustom = function() {
    const inviteInput = document.getElementById('inviteLinkCustom');
    inviteInput.select();
    document.execCommand('copy');
        hideInviteModalCustom();
 //   alert('Invite link copied!');
  };
  
  // Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const logOffBtn = document.getElementById('logOffBtn');
    
    if (logOffBtn) {
        logOffBtn.addEventListener('click', function() {
            // Clear session storage
            sessionStorage.clear();
            
            // Reset header to default
            const usernameEl = document.getElementById('headerUsername');
            const avatarEl = document.getElementById('headerUserAvatar');
            if (usernameEl) usernameEl.textContent = 'User';
            if (avatarEl) avatarEl.innerHTML = '';
            
            // Redirect to main.html
            window.location.href = 'About.html';
        });
    }
});

</script>
 <!-- Add this before the closing 
<div id="exportCsvModal">
  <div class="modal-content">
    <h3>Export Stories to CSV</h3>
    
    <div class="field-mapping">
      <div>
        <label for="csvStoryId">Story ID:</label>
        <select id="csvStoryId"></select>
      </div>
      <div>
        <label for="csvTitle">Title/Description:</label>
        <select id="csvTitle"></select>
      </div>
      <div>
        <label for="csvPoints">Story Points:</label>
        <select id="csvPoints"></select>
      </div>
      <div>
        <label for="csvVotes">Vote Count:</label>
        <select id="csvVotes"></select>
      </div>
      <div>
        <label for="csvAverage">Average Vote:</label>
        <select id="csvAverage"></select>
      </div>
    </div>
    
    <div class="export-options">
      <label><input type="checkbox" id="csvHeaderRow" checked> Include header row</label>
      <label><input type="checkbox" id="csvOnlyRevealed"> Only export stories with revealed votes</label>
      <label><input type="checkbox" id="csvDetailedVotes"> Include detailed vote information</label>
    </div>
    
    <div class="csv-preview" id="csvPreview">Preview will appear here...</div>
    
    <div class="button-group">
      <button class="cancel-btn">Cancel</button>
      <button class="confirm-btn">Export CSV</button>
    </div>
  </div>
</div>

     <div id="hostModeErrorModal" class="modal" style="display:none;">
  <div class="modal-content">
    <p class="modal-message">Host already available</p>
    <button onclick="document.getElementById('hostModeErrorModal').style.display='none'">OK</button>
  </div>
</div>

</body> tag 
<script src="userlist-fix.js"></script> -->
<script>
  // Force user list fix on page interaction
  document.addEventListener('click', function() {
    if (typeof directUserFix === 'function') {
      directUserFix();
    }
  }, { once: true });
</script>
   <script>
  // Helper function to hide all original modals
  function hideAllOriginalModals() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      modal.style.display = 'none';
    });
  }

  // Mobile-specific card functions
  window.fixRevealedVoteFontSizes = function() {
    const voteCards = document.querySelectorAll('.vote-card-space.has-vote .vote-badge');
    const isMobile = window.innerWidth <= 768;
    
    voteCards.forEach(badge => {
      const text = badge.textContent || '';
      let fontSize = isMobile ? '14px' : '18px'; // Smaller base size on mobile
      
      if (text.length >= 2) {
        fontSize = isMobile ? '12px' : '16px';
      }
      
      if (text.includes('XX')) {
        fontSize = isMobile ? '10px' : '14px';
      }
      
      badge.style.fontSize = fontSize;
      badge.style.maxWidth = '80%';
      badge.style.textAlign = 'center';
      badge.style.lineHeight = '1';
      badge.style.overflow = 'hidden';
    });
  };
  
  // Make emitVote function available for mobile use
  window.emitVote = function(vote, targetUserId) {
    if (window.socket) {
      window.socket.emit('castVote', { vote, targetUserId });
      
      // Show selection feedback
      const cards = document.querySelectorAll('#planningCards .card');
      cards.forEach(card => {
        card.classList.remove('selected-card');
        if (card.getAttribute('data-value') === vote) {
          card.classList.add('selected-card');
        }
      });
    }
  };
        
document.addEventListener('DOMContentLoaded', function() {
  // Only run on mobile/tablet devices
  if (window.innerWidth <= 1024) {
    applyExactMobileLayout();
  }
  
  // Also apply when window is resized
  window.addEventListener('resize', function() {
    if (window.innerWidth <= 1024) {
      applyExactMobileLayout();
    }
  });
  
  function applyExactMobileLayout() {
    console.log("Applying exact mobile layout from reference image");
    
    // Create style element for the exact mobile layout
    const mobileStyle = document.createElement('style');
    mobileStyle.id = 'exact-mobile-layout';
    mobileStyle.textContent = `
      /* Reset container layout */
      .container {
        display: block !important;
        padding-bottom: 100px !important;
        background: white !important;
      }
      
      /* Header styling */
      header {
        padding: 12px 20px !important;
        border-bottom: 1px solid #f0f0f0 !important;
      }
      
      /* Hide sidebar on mobile and show as a collapsible section */
      .sidebar {
        width: 100% !important;
        padding: 15px 20px !important;
        border: none !important;
        box-shadow: none !important;
      }
      
      /* Hide redundant elements */
      .upload-section, .planning-cards-section h3 {
        display: none !important;
      }
      
      /* Main content area */
      .main {
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        order: 2 !important;
      }
      
      /* Right sidebar styling */
      .rightbar {
        width: 320px !important;
        padding: 15px 20px !important;
        border: none !important;
        max-height: 300px !important;
        overflow-y: auto !important;
      }
      
      /* Story cards */
      .story-card {
        margin-bottom: 8px !important;
        border: 1px solid #e0e0e0 !important;
        border-radius: 8px !important;
        padding: 12px !important;
      }
      
      /* Avatar styling */
      #userCircle {
        padding: 15px 5px !important;
        margin-bottom: 60px !important;
      }
      
      .avatar-circle {
        width: 60px !important;
        height: 60px !important;
        font-size: 24px !important;
        background-color: #f5ba55 !important;
        color: white !important;
        border: none !important;
      }
      
      /* Vote card space */
      .vote-card-space {
        width: 60px !important;
        height: 80px !important;
        border: 2px dashed #ccc !important;
        background-color: white !important;
        border-radius: 8px !important;
      }
      
      /* Reveal votes button */
      .reveal-votes-button {
        background-color: white !important;
        color: #673ab7 !important;
        border: 2px solid #673ab7 !important;
        text-transform: uppercase !important;
        font-weight: bold !important;
        border-radius: 30px !important;
        padding: 10px 20px !important;
      }
      
      /* Fixed card panel at bottom */
      .card-panel {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100% !important;
        background: white !important;
        border-top: 1px solid #e0e0e0 !important;
        padding: 10px 5px !important;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1) !important;
        display: flex !important;
        justify-content: center !important;
        z-index: 1000 !important;
      }
      
      /* Planning cards styling to match design */
      .cards {
        display: flex !important;
        justify-content: center !important;
        gap: 8px !important;
        padding: 8px 0 !important;
      }
      
      .card {
        width: 50px !important;
        height: 50px !important;
        background-color: #e1d4f9 !important;
        color: #333 !important;
        font-weight: bold !important;
        font-size: 16px !important;
        border-radius: 8px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
      }
      
      /* Add exact colors from reference */
      .button, #revealVotesBtn, #resetVotesBtn {
        color: #673ab7 !important;
        border-color: #673ab7 !important;
        border-radius: 30px !important;
      }
      
      /* Make invite and upload buttons match design */
      .invite-button, .file-button {
        border-radius: 30px !important;
        min-width: 120px !important;
      }
      
      /* Exact alignment for navigation buttons */
      .navigation-buttons {
        display: flex !important;
        justify-content: space-between !important;
        padding: 0 10px !important;
        margin: 15px 0 !important;
      }
      
      /* Enhance add ticket button */
      .add-ticket-btn {
        border-radius: 30px !important;
        color: #673ab7 !important;
        border-color: #673ab7 !important;
        font-weight: bold !important;
        margin-bottom: 15px !important;
      }
    `;
    document.head.appendChild(mobileStyle);
    
    // Move the planning cards to the bottom in a fixed panel
    const planningCards = document.querySelector('#planningCards');
    if (planningCards && !document.querySelector('.mobile-card-panel')) {
      const cardPanel = document.createElement('div');
      cardPanel.className = 'card-panel mobile-card-panel';
      
      // Add PLANNING CARDS heading above the cards
      const cardsHeading = document.createElement('div');
      cardsHeading.textContent = 'PLANNING CARDS';
      cardsHeading.style.cssText = 'color:#673ab7; font-size:14px; font-weight:600; margin-bottom:5px; text-align:center; width:100%; text-transform:uppercase;';
      
      // Move cards to the panel
      cardPanel.appendChild(cardsHeading);
      cardPanel.appendChild(planningCards);
      document.body.appendChild(cardPanel);
    }
    
    // Add Upload Ticket and Invite Others buttons at the top
    const header = document.querySelector('header');
    if (header && !document.querySelector('.mobile-action-buttons')) {
      const actionButtons = document.createElement('div');
      actionButtons.className = 'mobile-action-buttons';
      actionButtons.style.cssText = 'display:flex; gap:10px; justify-content:flex-end; padding:10px 20px; border-bottom:1px solid #f0f0f0;';
      
      const uploadButton = document.createElement('button');
      uploadButton.textContent = 'Upload Ticket';
      uploadButton.className = 'invite-button';
      uploadButton.onclick = function() {
        document.getElementById('csvInput').click();
      };
      
      const inviteButton = document.createElement('button');
      inviteButton.textContent = 'Invite Others';
      inviteButton.className = 'invite-button';
      inviteButton.onclick = function() {
        window.showInviteModalCustom();
      };
      
      actionButtons.appendChild(uploadButton);
      actionButtons.appendChild(inviteButton);
      
      header.insertAdjacentElement('afterend', actionButtons);
    }
    
    // Enhance user voting area
    setupMobileCardSelection();
  }
  
  function setupMobileCardSelection() {
    document.querySelectorAll('#planningCards .card').forEach(card => {
      card.addEventListener('touchend', function(e) {
        e.preventDefault();
        
        // Get current user's vote space
        const userName = sessionStorage.getItem('userName');
        if (!userName) return;
        
        const safeId = userName.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-_]/g, '');
        const voteSpace = document.getElementById(`vote-space-${safeId}`);
        
        if (voteSpace) {
          const vote = this.getAttribute('data-value');
          
          // Clear selections and add to this card
          document.querySelectorAll('#planningCards .card').forEach(c => {
            c.classList.remove('selected-card');
          });
          this.classList.add('selected-card');
          
          // Use the emitVote function if available
          if (typeof window.emitVote === 'function') {
            window.emitVote(vote, userName);
          } else if (typeof window.socket !== 'undefined') {
            window.socket.emit('castVote', { vote, targetUserId: userName });
          }
        }
      });
    });
  }
});
  
// Connection status indicator
const statusIndicator = document.getElementById('connectionStatus');

function updateConnectionStatus(status) {
  if (!statusIndicator) return;
  
  switch(status) {
    case 'connected':
      statusIndicator.className = 'connection-status';
      statusIndicator.title = 'Connected';
      break;
    case 'connecting':
      statusIndicator.className = 'connection-status connecting';
      statusIndicator.title = 'Connecting...';
      break;
    case 'disconnected':
      statusIndicator.className = 'connection-status disconnected';
      statusIndicator.title = 'Disconnected';
      break;
  }
}

// Update status when socket events occur
document.addEventListener('DOMContentLoaded', function() {
  if (window.socket) {
    window.socket.on('connect', () => updateConnectionStatus('connected'));
    window.socket.on('disconnect', () => updateConnectionStatus('disconnected'));
    window.socket.on('connecting', () => updateConnectionStatus('connecting'));
    window.socket.on('reconnecting', () => updateConnectionStatus('connecting'));
  }
});
</script>
<script>
let csvData = [];
let csvHeaders = [];
let selectedCsvFile = null;
let importInProgress = false;

// Show CSV Upload Modal
function showCsvUploadModal() {
  document.getElementById('csvUploadModal').style.display = 'flex';
  document.getElementById('csvUploadStep').classList.add('active');
  document.getElementById('csvMappingStep').classList.remove('active');
  
  // Reset everything
  selectedCsvFile = null;
  csvData = [];
  csvHeaders = [];
  importInProgress = false;
  document.getElementById('csvFileInput').value = '';
}

// Hide CSV Upload Modal
function hideCsvUploadModal() {
  document.getElementById('csvUploadModal').style.display = 'none';
  document.getElementById('csvUploadStep').classList.add('active');
  document.getElementById('csvMappingStep').classList.remove('active');
  
  // Reset everything
  selectedCsvFile = null;
  csvData = [];
  csvHeaders = [];
  importInProgress = false;
  document.getElementById('csvFileInput').value = '';
  document.getElementById('useFirstRowAsHeaders').checked = true;
}

// Trigger file input - Make this a simple global function
function triggerCsvFileInput() {
  console.log('triggerCsvFileInput called');
  const fileInput = document.getElementById('csvFileInput');
  if (fileInput) {
    console.log('File input found, clicking...');
    fileInput.click();
  } else {
    console.error('File input not found');
  }
}

// Go back to upload step
function goBackToCsvUpload() {
  document.getElementById('csvUploadStep').classList.add('active');
  document.getElementById('csvMappingStep').classList.remove('active');
}

// Setup - Run only once
document.addEventListener('DOMContentLoaded', function() {
  // Prevent multiple setups
  if (window.csvSetupDone) return;
  window.csvSetupDone = true;
  
  console.log('Setting up CSV upload handlers');
  
  const fileInput = document.getElementById('csvFileInput');
  const importBtn = document.getElementById('importCsvBtn');
  const uploadTicketMenuBtn = document.getElementById('uploadTicketMenuBtn');
  
  // Disable old CSV system completely
  const oldCsvInput = document.getElementById('csvInput');
  if (oldCsvInput) {
    oldCsvInput.style.display = 'none';
    oldCsvInput.disabled = true;
  }
  
  // File input change handler
  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      console.log('File input changed');
      const file = e.target.files[0];
      if (file && file.name.toLowerCase().endsWith('.csv')) {
        selectedCsvFile = file;
        console.log('Selected file:', file.name);
        processCsvFile(file);
      } else if (file) {
        alert('Please select a valid CSV file.');
      }
    });
  }
  
  // Import button handler
  if (importBtn) {
    importBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Import button clicked');
      handleCsvImport();
    });
  }
  
  // Menu button handler
  if (uploadTicketMenuBtn) {
    uploadTicketMenuBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Upload ticket menu clicked');
      showCsvUploadModal();
    });
  }
});

// Process CSV file
function processCsvFile(file) {
  if (!file) {
    console.error('No file provided to processCsvFile');
    return;
  }
  
  console.log('Processing CSV file:', file.name);
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const csvText = e.target.result;
      console.log('CSV text loaded, length:', csvText.length);
      parseCsvContent(csvText);
    } catch (error) {
      console.error('Error processing CSV:', error);
      alert('Error processing CSV file: ' + error.message);
    }
  };
  
  reader.onerror = function() {
    console.error('FileReader error');
    alert('Error reading file');
  };
  
  reader.readAsText(file);
}

// Parse CSV content
function parseCsvContent(csvText) {
  if (!csvText || csvText.trim().length === 0) {
    alert('The CSV file appears to be empty.');
    return;
  }
  
  const lines = csvText.trim().split(/\r?\n/).filter(line => line.trim());
  const useHeaders = document.getElementById('useFirstRowAsHeaders').checked;
  
  console.log('Parsing CSV, lines found:', lines.length);
  
  // Simple CSV parsing
  const parsedData = [];
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    const row = [];
    let current = '';
    let inQuotes = false;
    
    for (let j = 0; j < line.length; j++) {
      const char = line[j];
      
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        row.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    
    row.push(current.trim());
    parsedData.push(row);
  }
  
  if (useHeaders && parsedData.length > 0) {
    csvHeaders = parsedData[0];
    csvData = parsedData.slice(1);
  } else {
    csvHeaders = parsedData[0] ? parsedData[0].map((_, index) => `Column ${index + 1}`) : [];
    csvData = parsedData;
  }
  
  console.log('CSV parsed - Headers:', csvHeaders);
  console.log('CSV parsed - Data rows:', csvData.length);
  
  if (csvData.length === 0) {
    alert('No data rows found in CSV file.');
    return;
  }
  
  showMappingStep();
}

// Show mapping step
// Show mapping step
function showMappingStep() {
  document.getElementById('csvUploadStep').classList.remove('active');
  document.getElementById('csvMappingStep').classList.add('active');
  
  populateMappingDropdowns();
  populatePreviewTable(); // Show initial preview
  
  // Update preview when mappings change
  const selects = document.querySelectorAll('.csv-mapping-select');
  selects.forEach(select => {
    select.addEventListener('change', populatePreviewTable);
  });
}

// Populate mapping dropdowns
function populateMappingDropdowns() {
  const mappingSelects = ['summaryMapping', 'keyMapping', 'descriptionMapping', 'linkMapping', 'estimateMapping'];
  
  mappingSelects.forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      select.innerHTML = '<option value="">Select...</option>';
      
      csvHeaders.forEach((header, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = header;
        select.appendChild(option);
      });
    }
  });
  
  autoMapFields();
}

// Auto-map common fields
function autoMapFields() {
  const mappings = {
    'summaryMapping': ['summary', 'title', 'subject', 'description', 'issue', 'story', 'name'],
    'keyMapping': ['key', 'id', 'number', 'ticket', 'issue_id'],
    'descriptionMapping': ['description', 'detail', 'details', 'body', 'content'],
    'linkMapping': ['link', 'url', 'href'],
    'estimateMapping': ['estimate', 'points', 'story_points', 'effort', 'size']
  };
  
  Object.keys(mappings).forEach(selectId => {
    const select = document.getElementById(selectId);
    if (select) {
      const keywords = mappings[selectId];
      
      for (let i = 0; i < csvHeaders.length; i++) {
        const header = csvHeaders[i].toLowerCase();
        if (keywords.some(keyword => header.includes(keyword))) {
          select.value = i;
          break;
        }
      }
    }
  });
}
// Populate preview table
function populatePreviewTable() {
  const previewEl = document.getElementById('importPreview');
  if (!previewEl) return;
  
  if (!csvData || csvData.length === 0) {
    previewEl.innerHTML = '<p>No data to preview</p>';
    return;
  }

  // Create table HTML structure
  let html = '<table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse; width:100%; font-size:12px;">';
  
  // Add header row
  html += '<thead><tr style="background:#f0f0f0;">';
  ['Summary', 'Key', 'Description', 'Link', 'Estimate'].forEach(headerText => {
    html += `<th style="padding:6px; border:1px solid #ccc;">${headerText}</th>`;
  });
  html += '</tr></thead>';
  
  // Add data rows (show first 5 rows as preview)
  html += '<tbody>';
  const previewData = csvData.slice(0, 5);
  
  previewData.forEach(row => {
    html += '<tr>';
    
    // Get mapping values
    const summaryIndex = document.getElementById('summaryMapping')?.value || '';
    const keyIndex = document.getElementById('keyMapping')?.value || '';
    const descIndex = document.getElementById('descriptionMapping')?.value || '';
    const linkIndex = document.getElementById('linkMapping')?.value || '';
    const estimateIndex = document.getElementById('estimateMapping')?.value || '';
    
    // Extract values based on mappings
    const values = [
      summaryIndex !== '' ? (row[parseInt(summaryIndex)] || '') : '',
      keyIndex !== '' ? (row[parseInt(keyIndex)] || '') : '',
      descIndex !== '' ? (row[parseInt(descIndex)] || '') : '',
      linkIndex !== '' ? (row[parseInt(linkIndex)] || '') : '',
      estimateIndex !== '' ? (row[parseInt(estimateIndex)] || '') : ''
    ];
    
    values.forEach(value => {
      const cellValue = String(value).substring(0, 50); // Limit cell content length
      html += `<td style="padding:6px; border:1px solid #ccc; max-width:150px; overflow:hidden; text-overflow:ellipsis;">${cellValue}</td>`;
    });
    
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  
  if (csvData.length > 5) {
    html += `<p style="font-size:12px; color:#666; margin-top:8px;">Showing first 5 rows of ${csvData.length} total rows</p>`;
  }
  
  previewEl.innerHTML = html;
}

// Handle CSV Import - FIXED VERSION
function handleCsvImport() {
  if (importInProgress) {
    console.log('Import already in progress');
    return;
  }
  
  console.log('Starting CSV import...');
  console.log('Selected file:', selectedCsvFile?.name);
  console.log('CSV data rows:', csvData.length);
  
  if (!csvData || csvData.length === 0) {
    alert('No CSV data to import. Please select a valid CSV file.');
    return;
  }
  
  importInProgress = true;
  
  try {
    const summaryMapping = document.getElementById('summaryMapping')?.value || '';
    const keyMapping = document.getElementById('keyMapping')?.value || '';
    const descMapping = document.getElementById('descriptionMapping')?.value || '';
    
    if (!summaryMapping && !keyMapping) {
      alert('Please select at least Summary or Key field mapping.');
      importInProgress = false;
      return;
    }
    
    console.log('Import mappings - Summary:', summaryMapping, 'Key:', keyMapping, 'Desc:', descMapping);
    console.log('CSV Headers:', csvHeaders);
    console.log('Sample CSV row:', csvData[0]);
    
    let importedCount = 0;
    
    // Import each row
    csvData.forEach((row, index) => {
      console.log(`Processing row ${index}:`, row);
      
      // FIXED: Get the actual values using parseInt for mapping indices
      const summaryIndex = summaryMapping !== '' ? parseInt(summaryMapping) : -1;
      const keyIndex = keyMapping !== '' ? parseInt(keyMapping) : -1;
      const descIndex = descMapping !== '' ? parseInt(descMapping) : -1;
      
      const summary = summaryIndex >= 0 ? (row[summaryIndex] || '').trim() : '';
      const key = keyIndex >= 0 ? (row[keyIndex] || '').trim() : `Item_${index + 1}`;
      const description = descIndex >= 0 ? (row[descIndex] || '').trim() : '';
      
      console.log(`Row ${index} extracted: summary="${summary}", key="${key}", desc="${description}"`);
      
      // Only import if we have meaningful data
      if (summary || (key && key !== `Item_${index + 1}`)) {
        // FIXED: Use the correct displayText logic
        const displayText = summary || key;
        
        const ticketData = {
          id: `story_csv_${Date.now()}_${index}`,
          text: displayText, // This should be the main display text
          idDisplay: key,    // This is the key/ID field
          descriptionDisplay: description, // This is the description field
          originalText: displayText,
          originalLang: 'en'
        };
        
        console.log('Creating ticket with correct data:', ticketData);
        
        // Add to UI using the main.js function
        if (window.addTicketFromModal && typeof window.addTicketFromModal === 'function') {
          window.addTicketFromModal(ticketData);
          importedCount++;
        } else {
          console.error('addTicketFromModal function not available');
        }
      } else {
        console.log(`Row ${index} skipped - no meaningful data`);
      }
    });
    
    console.log(`Import completed. Created ${importedCount} tickets.`);
    
    // Close modal and show success
    hideCsvUploadModal();
    
  } catch (error) {
    console.error('Error during import:', error);
    alert('Error during import: ' + error.message);
  } finally {
    importInProgress = false;
  }
}

</script>

<!-- Add this just before the closing 
<div id="exportCsvModal">
  <div class="modal-content">
    <h3>Export Stories to CSV</h3>
    
    <div class="field-mapping">
      <div>
        <label for="csvStoryId">Story ID:</label>
        <select id="csvStoryId"></select>
      </div>
      <div>
        <label for="csvTitle">Title/Description:</label>
        <select id="csvTitle"></select>
      </div>
      <div>
        <label for="csvPoints">Story Points:</label>
        <select id="csvPoints"></select>
      </div>
      <div>
        <label for="csvVotes">Vote Count:</label>
        <select id="csvVotes"></select>
      </div>
      <div>
        <label for="csvAverage">Average Vote:</label>
        <select id="csvAverage"></select>
      </div>
    </div>
    
    <div class="export-options">
      <label><input type="checkbox" id="csvHeaderRow" checked> Include header row</label>
      <label><input type="checkbox" id="csvOnlyRevealed"> Only export stories with revealed votes</label>
      <label><input type="checkbox" id="csvDetailedVotes"> Include detailed vote information</label>
    </div>
    
    <div class="csv-preview" id="csvPreview">Preview will appear here...</div>
    
    <div class="button-group">
      <button class="cancel-btn">Cancel</button>
      <button class="confirm-btn">Export CSV</button>
    </div>
  </div>
</div>

</body> tag in index.html -->


    <script type="module" src="main.js"></script>

<script>
document.getElementById('joinSessionWithName').addEventListener('click', function () {
  const nameInput = document.getElementById('userNameInput');
  const userName = nameInput.value.trim();

  if (!userName) {
    alert('Please enter your name to join.');
    return;
  }

  sessionStorage.setItem('userName', userName);

  const urlParams = new URLSearchParams(window.location.search);
  let roomId = urlParams.get('roomId');
  if (!roomId) {
    roomId = 'room-' + Math.floor(Math.random() * 10000);
    const newUrl = window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'roomId=' + roomId;
    window.history.pushState({ path: newUrl }, '', newUrl);
  }

  // Get and save Requested Host Variable before redirect
  const requestHost = document.getElementById("allowJoinAsHost").checked;
  sessionStorage.setItem("requestedHost", requestHost);

  // Load the new page
  window.location.href = "index.html?roomId=" + roomId;

  document.getElementById('loginModalCustom').style.display = 'none';
});
</script>

<!-- Translation Loading Overlay (for language-manager.js) -->
<div id="translationOverlay" style="display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10001; background:rgba(0,0,0,0.45); color: white; font-size: 2em; align-items:center;justify-content:center; flex-direction:column;">
  <div class="loading-spinner" style="margin-bottom:16px;"></div>
  Translating, please wait...
</div>
  <!-- Premium Upgrade Modal -->
<div id="premiumModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px 32px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.2); max-width:400px; text-align:center;">
    <h2 style="margin-bottom:12px;">üîí Premium Feature</h2>
    <p style="margin-bottom:20px;">This feature is only available in the Premium version.</p>
    <button onclick="closePremiumModal()" style="padding:8px 16px; background:#753acb; color:white; border:none; border-radius:5px; cursor:pointer;">Got it</button>
  </div>
</div>


<div id="exportCsvModal">
  <div class="modal-content">
    <h3>Export Stories to CSV</h3>
    
    <div class="field-mapping">
      <div>
        <label for="csvStoryId">Story ID:</label>
        <select id="csvStoryId"></select>
      </div>
      <div>
        <label for="csvTitle">Title/Description:</label>
        <select id="csvTitle"></select>
      </div>
      <div>
        <label for="csvPoints">Story Points:</label>
        <select id="csvPoints"></select>
      </div>
      <div>
        <label for="csvVotes">Vote Count:</label>
        <select id="csvVotes"></select>
      </div>
      <div>
        <label for="csvAverage">Average Vote:</label>
        <select id="csvAverage"></select>
      </div>
    </div>
    
    <div class="export-options">
      <label><input type="checkbox" id="csvHeaderRow" checked> Include header row</label>
      <label><input type="checkbox" id="csvOnlyRevealed"> Only export stories with revealed votes</label>
      <label><input type="checkbox" id="csvDetailedVotes"> Include detailed vote information</label>
    </div>
    
    <div class="csv-preview" id="csvPreview">Preview will appear here...</div>
    
    <div class="button-group">
      <button class="cancel-btn">Cancel</button>
      <button class="confirm-btn">Export CSV</button>
    </div>
  </div>
</div>

</body>
</html>
  
